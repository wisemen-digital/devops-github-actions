---
name: Rollout deployments (Scaleway)

#
# Check what's changed (via filters, or provide your own list) and roll it out.
#

on:
  workflow_call:
    # Depends on the following vars
    # - K8S_CLUSTER_ID
    # - SCALEWAY_ORGANIZATION_ID
    # - SCALEWAY_PROJECT_ID
    # - SCALEWAY_REGION
    inputs:
      # Cluster info
      cluster-deployments:
        description: List of deployments to roll out (folders), separated by commas
        required: true
        type: string
    secrets:
      K8S_MODULES_SECRET:
        description: Token to access github modules repositories
        required: true
      SCALEWAY_ACCESS_KEY:
        description: Scaleway API key ID
        required: true
      SCALEWAY_SECRET_KEY:
        description: Scaleway API key secret
        required: true

jobs:
  deprecation-warning:
    name: Deprecation message
    runs-on: ubuntu-latest
    steps:
      - name: Deprecation message
        run: echo "::warning file=.github/workflows/rollout-to-k8s.yml,line=20::Deprecated workflow, switch to vendor agnostic workflow."

  rollout-to-k8s:
    uses: wisemen-digital/devops-github-actions/.github/workflows/infra-k8s-rollout.yml@main
    with:
      vendor: scaleway
      cluster-deployments: ${{ inputs.cluster-deployments }}
    secrets:
      K8S_MODULES_SECRET: ${{ secrets.K8S_MODULES_SECRET }}
      SCALEWAY_ACCESS_KEY: ${{ secrets.SCALEWAY_ACCESS_KEY }}
      SCALEWAY_SECRET_KEY: ${{ secrets.SCALEWAY_SECRET_KEY }}

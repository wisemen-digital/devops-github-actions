---
name: Flutter package/module workflow

#
# Download artifact, organize generated files, analyze, run tests and report coverage
# Note: will create artifact for coverage reports.
#

on:
  workflow_call:
    inputs:
      package_name:
        required: true
        description: Package name (artifacts)
        type: string
      working_directory:
        required: true
        default: "."
        description: The working directory for this workflow
        type: string
      min_coverage:
        required: false
        default: 0
        description: The minimum coverage percentage value (defaults to 0)
        type: number
      github_token:
        required: true
        description: The GitHub token to use for reporting coverage
        type: string

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: merged-artifacts
        path: tmp-artifacts

    - name: Move artifacts
      shell: bash
      run: |
        rsync -a --ignore-existing --remove-source-files tmp-artifacts/app-lib/* lib
        rm -rf tmp-artifacts/app-lib/
        rsync -a --ignore-existing --remove-source-files tmp-artifacts/intl/* lib/generated
        rm -rf tmp-artifacts/intl/
        for package in ./tmp-artifacts/*; do
          packageName=$(basename "$package")
          if [ -d "$package" ]; then
            rsync -a --ignore-existing --remove-source-files "$package/" "packages/$packageName/"
          fi
        done
        rm -rf tmp-artifacts/

    - name: Analyze project source
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      run: dart analyze --fatal-infos --fatal-warnings

    - name: Run Flutter WiseClient tests
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      run: flutter test --no-pub --coverage

    - name: Setup LCOV
      uses: hrishikesh-kadam/setup-lcov@v1

    - name: Report code coverage
      uses: zgosalvez/github-actions-report-lcov@v4
      with:
        coverage-files: ${{ inputs.working_directory }}/coverage/lcov.info
        minimum-coverage: ${{ inputs.min_coverage }}
        github-token: ${{ inputs.github_token }}
        working-directory: ${{ inputs.working_directory }}
        artifact-name: ${{ inputs.package_name }}-coverage

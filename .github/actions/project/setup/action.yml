---
name: Prep. project environment
description: |
  Prepare the Node / PNPM environment
inputs:
  apps:
    description: List of changed apps (build matrix generated by earlier job)
    required: true
  node-version:
    description: Node Version (such as 20.5)
    required: false
    default: 'lts/*'
outputs:
  pnpm-filter-args:
    description: Arguments for a `pnpm` command to only trigger for the given apps
    value: ${{ steps.values.outputs.pnpm_filter_args }}

runs:
  using: composite
  steps:
    # Calculate values
    - name: Calculate values
      if: ${{ inputs.apps != '' && inputs.apps != '[]' }}
      shell: bash
      id: values
      run: |
        changed_apps=`echo '${{ inputs.apps }}' | jq -r '.[] | select(.skip != true) | .path'`

        FILTER_ARGS=()
        while IFS= read -r item; do
          [[ -n "$item" ]] || continue
          FILTER_ARGS+=(--filter "${item}")
        done <<< "$changed_apps"

        echo "pnpm_filter_args=${FILTER_ARGS[@]}" >> "$GITHUB_OUTPUT"
    # Prep. Node environment
    - name: Checkout
      uses: actions/checkout@v6
    - name: Install pnpm
      uses: pnpm/action-setup@v4
    - name: Install Node.js
      uses: actions/setup-node@v6
      with:
        node-version: ${{ inputs.node-version }}
        cache: 'pnpm'
    - name: Install dependencies
      shell: bash
      run: pnpm install --frozen-lockfile --prefer-offline

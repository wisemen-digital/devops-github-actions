---
name: K8S Setup
description: Prepare kubectl for communication with a cluster
inputs:
  vendor:
    description: The vendor to communicate with (azure, digitalocean, scaleway)
    required: true
  cluster-id:
    description: Target cluster ID
    required: true
  # Vendor: Azure
  azure-client-id:
    description: Azure client ID for login with an Azure service principal
    required: false
  azure-tenant-id:
    description: Azure tenant ID for login with an Azure service principal
    required: false
  azure-subscription-id:
    description: Azure subscription ID for login with an Azure service principal
    required: false
  azure-resource-group:
    description: Resource group name
    required: false
  # Vendor: DigitalOcean
  digitalocean-api-token:
    description: DigitalOcean API token
    required: false
  # Vendor: Scaleway
  scaleway-organization-id:
    description: Scaleway organization ID
    required: false
  scaleway-project-id:
    description: Scaleway project ID
    required: false
  scaleway-region:
    description: Scaleway deployment region (such as nl-ams)
    required: false
  scaleway-access-key:
    description: Scaleway API key ID
    required: false
  scaleway-secret-key:
    description: Scaleway API key secret
    required: false

runs:
  using: composite
  steps:
    # Validate inputs
    - name: Validate inputs
      shell: bash
      run: |
        function validate-required-input {
          if [ -z "$2" ]; then echo "Missing input: $1"; exit 1; fi
        }

        echo "Validating inputs for vendor: ${{ inputs.vendor }}"
        case "${{ inputs.vendor }}" in
          azure)
            validate-required-input azure-client-id '${{ inputs.azure-client-id }}'
            validate-required-input azure-tenant-id '${{ inputs.azure-tenant-id }}'
            validate-required-input azure-subscription-id '${{ inputs.azure-subscription-id }}'
            validate-required-input azure-resource-group '${{ inputs.azure-resource-group }}'
            ;;
          digitalocean)
            validate-required-input digitalocean-api-token '${{ inputs.digitalocean-api-token }}'
            ;;
          scaleway)
            validate-required-input scaleway-access-key '${{ inputs.scaleway-access-key }}'
            validate-required-input scaleway-organization-id '${{ inputs.scaleway-organization-id }}'
            validate-required-input scaleway-project-id '${{ inputs.scaleway-project-id }}'
            validate-required-input scaleway-region '${{ inputs.scaleway-region }}'
            validate-required-input scaleway-secret-key '${{ inputs.scaleway-secret-key }}'
            ;;
          *)
            echo "Unsupported vendor '${{ inputs.vendor }}'"
            exit 1
            ;;
        esac

    # Vendor: Azure
    - name: Set up kubelogin for non-interactive login
      if: ${{ inputs.vendor == 'azure' }}
      uses: azure/use-kubelogin@v1
      with:
        kubelogin-version: 'latest'
      env:
        GITHUB_TOKEN: ${{ github.token }}
    - name: Azure Login
      if: ${{ inputs.vendor == 'azure' }}
      uses: azure/login@v2
      with:
        client-id: ${{ inputs.azure-client-id }}
        tenant-id: ${{ inputs.azure-tenant-id }}
        subscription-id: ${{ inputs.azure-subscription-id }}
    - name: Save Azure kubeconfig
      if: ${{ inputs.vendor == 'azure' }}
      uses: azure/aks-set-context@v4
      with:
        resource-group: ${{ inputs.azure-resource-group}}
        cluster-name: ${{ inputs.cluster-id }}
        admin: 'false'
        use-kubelogin: 'true'

    # Vendor: Digitalocean
    - name: Install doctl tool
      if: ${{ inputs.vendor == 'digitalocean' }}
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ inputs.digitalocean-api-token }}
    - name: Save DigitalOcean kubeconfig
      if: ${{ inputs.vendor == 'digitalocean' }}
      shell: bash
      run: doctl k8s cluster kubeconfig save ${{ inputs.cluster-id }}

    # Vendor: Scaleway
    - name: Install scw tool
      if: ${{ inputs.vendor == 'scaleway' }}
      uses: scaleway/action-scw@v0
      with:
        access-key: ${{ inputs.scaleway-access-key }}
        secret-key: ${{ inputs.scaleway-secret-key }}
        default-organization-id: ${{ inputs.scaleway-organization-id }}
        default-project-id: ${{ inputs.scaleway-project-id }}
        export-config: true
        save-config: true
    - name: Save Scaleway kubeconfig
      if: ${{ inputs.vendor == 'scaleway' }}
      shell: bash
      run: scw k8s kubeconfig install ${{ inputs.cluster-id }} region=${{ inputs.scaleway-region }}
